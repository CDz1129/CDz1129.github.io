---
layout:     post
title:      Golangå­¦ä¹ ç¬”è®°äºŒåä¸€
subtitle:   httpæµ‹è¯•
date:       2019-03-18
author:     CDz
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - Golang
    - æµ‹è¯•
---

# Httpæµ‹è¯•

ä¹‹å‰éƒ½æ˜¯æµ‹è¯•çš„é€»è¾‘ä»£ç ,GOå¯¹äºhttpserveræµ‹è¯•ä¸€æ ·ä¹Ÿæ˜¯æ”¯æŒçš„,è¿™æ¬¡æˆ‘ä»¬å°±æµ‹è¯•,ä¹‹å‰å†™çš„,[è¯»æ–‡ä»¶æœåŠ¡å™¨](https://cdz1129.github.io/2019/02/16/golang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81%E5%85%AB/#%E6%94%B9%E8%BF%9B%E5%90%8C%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86)ä¸­çš„ç»Ÿä¸€å¤„ç†é”™è¯¯`errWrapper`

è¦æµ‹è¯•HTTPæœåŠ¡å™¨,å°‘ä¸äº†requestä¸response.è¿™ä¸¤ä¸ªä¸œè¥¿,æˆ‘ä»¬å¯ä»¥åœ¨`httptest`åŒ…ä¸‹,æ‰¾åˆ°å¯¹åº”çš„æ¨¡æ‹Ÿå™¨.

```
func errPanic(writer http.ResponseWriter, request *http.Request) error {
    panic(123)
}

func TestErrWrapper(t *testing.T) {
    tests := []struct {
        hander appHandler //handler
        code int
        message string
    }{
        //å…ˆæµ‹è¯•ä¸€ä¸ª 500é”™è¯¯çš„
        {errPanic,http.StatusInternalServerError,http.StatusText(
        http.StatusInternalServerError)},
    }

    for _, tt := range tests {
        recorder := httptest.NewRecorder()
        request := httptest.NewRequest(http.MethodGet, "http://www.baidu.com", nil)
        //ä½¿ç”¨httptest æ¨¡æ‹Ÿ request ä¸ response,
        //è¿™é‡Œrequest æˆ‘ä»¬éšä¾¿è¾“å…¥çš„urlå› ä¸ºå¿…é¡»å¡«å†™,ä¸”è¿™é‡Œåªæµ‹è¯•errWrapperå‡½æ•°,æ²¡æœ‰ç”¨åˆ°url
        wrapper := errWrapper(tt.hander)
        wrapper(recorder,request)
        code := recorder.Code
        buffer := recorder.Body
        readAll, _ := ioutil.ReadAll(buffer)
        s := strings.Trim(string(readAll),"\n")
        if code!=tt.code || s != tt.message{
            t.Errorf("è¾“å‡ºï¼ˆ%d,%sï¼‰,åº”è¯¥å¾—åˆ°ï¼ˆ%d,%sï¼‰",
                recorder.Code,s,
                tt.code,tt.message)
        }
    }
}
```

æµ‹è¯•é€šè¿‡,ä¸‹é¢å°±æ˜¯ç ä»£ç ,å»æµ‹è¯•å…¶ä»–çš„é”™è¯¯ä¿¡æ¯.æ¯ä¸ªä¸åŒé”™è¯¯å°è£…ä¸€ä¸ªhandlerå°±å¥½äº†.

# çœŸå®serveræµ‹è¯•

çœŸå®serveræµ‹è¯•,æ˜¯åœ¨æµ‹è¯•æ—¶èµ·ä¸€ä¸ªserverå»æµ‹è¯•,ç›¸è¾ƒäºä¸Šä¸€ä¸ªä½¿ç”¨å‡çš„requestä¸response,è·Ÿå…¨é¢,ä½†ä¹Ÿä¼šæµ‹è¯•æ…¢ä¸€äº›.
```
func TestErrWrapperInServer(t *testing.T) {
    for _, tt := range tests {
        h := errWrapper(tt.hander)
        //ä½¿ç”¨httptest.NewServer ç›´æ¥èµ·ä¸€ä¸ªæœåŠ¡å™¨æµ‹è¯•
        server := httptest.NewServer(http.HandlerFunc(h))
        resp, _ := http.Get(server.URL)
        code := resp.StatusCode
        buffer := resp.Body
        readAll, _ := ioutil.ReadAll(buffer)
        s := strings.Trim(string(readAll), "\n")
        if code != tt.code || s != tt.message {
            t.Errorf("è¾“å‡ºï¼ˆ%d,%sï¼‰,åº”è¯¥å¾—åˆ°ï¼ˆ%d,%sï¼‰",
                resp.StatusCode, s,
                tt.code, tt.message)
        }
    }
}
```




------
ä½œè€…æ‰€æœ‰çš„å­¦ä¹ æºç åœ¨ [goå­¦ä¹ æºç githubåœ°å€](https://github.com/CDz1129/golang-learn),å¦‚æœè§‰å¾—æœ‰ç”¨çš„è¯å¸®å°æ™ºè´¡çŒ®ä¸€ä¸ªstarğŸ˜
