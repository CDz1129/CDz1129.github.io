---
layout:     post
title:      zk学习笔记二
subtitle:   acl(access control list)权限控制
date:       2018-12-21
author:     CDz
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - zookeeper
    - 中间件
---


# acl(access control list)权限控制

- zk的权限控制,可以控制节点的读写操作,保证数据的安全性
- 权限的permission可以指定不同的权限范围及角色

命令:

- getAcl path 获取节点权限信息
- setAcl path acl 设置节点权限信息
- addauth scheme auth 输入注册用户(认证授权信息),输入时使用明文密码,在zk中密码是以密文加密形式存在

## acl构成

> [scheme:id:permissions]构成权限列表

- scheme 采取某种权限机制(只能使用内置的几种)
    + world 只有一个用户,就是anyone,任何人都可以访问,形式为`world:anyone:[permissions]`
    + auth 需要注册认证的用户(即通过`addauth`的用户),形式为`auth:user:password:[permissions]`
    + digest 同auth一样需要注册认证的用户,但是密码形式不同,密码为加密后密码,形式为`digest:user:BASE64(SHA1(password)):permissions`
    + ip 可以添加ip权限机制,形式为`ip:162.0.0.1:permissions`
    + super 代表超级管理员拥有所有权限
- id 代表访问用户
- permissions 权限组合字符串(crdwa)
    + c -> create
    + r -> read
    + d -> delete(针对子节点权限,比如设置`>> setAcl /names world:anyone:crwa`,删除`>> delete /names`是可以成功的,但是删除其子节点`>> delete /names/zxc`返回`Authentication is not valid : /names/zxc`,说明delete权限针对的是子节点操作权限)
    + w -> write
    + a -> admin (具有此节点修改/设置权限的权限)

digest与auth区别:本质上来讲,更加安全.因为有时候不想给出密码因为密码可以干很多事情,所以有一个权限是通过密文就可以直接登录.

## 命令演示
```shell
>> getAcl /names/zxc
```
```shell
>> 'world,'anyone
>> : cdrwa
```

### scheme讲解

#### world-scheme解读

新建节点默认是world scheme且全部权限

```shell
>> [zk: localhost:2181(CONNECTED) 20] getAcl /names/zxc
>> 'world,'anyone
>> : cdrwa
```

    修改权限
```shell
>> [zk: localhost:2181(CONNECTED) 21] setAcl /names world:anyone:cra //有创建/读取/和设置权限的权限
```

尝试读取
```shell
[zk: localhost:2181(CONNECTED) 22] get /names //可以读取
111
cZxid = 0x10
ctime = Sat Dec 22 15:43:45 CST 2018
mZxid = 0x10
mtime = Sat Dec 22 15:43:45 CST 2018
pZxid = 0x15
cversion = 3
dataVersion = 0
aclVersion = 2
ephemeralOwner = 0x0
dataLength = 3
numChildren = 1
```

修改节点信息
```shell
[zk: localhost:2181(CONNECTED) 23] set /names 111  //因为没有修改权限失败
Authentication is not valid : /names
```

删除节点
```shell
[zk: localhost:2181(CONNECTED) 30] delete /names  //没有报错,直接删除成功??这是这么回事,其实d->delete权限是针对子节点的权限
```

创建一个字节
```shell
[zk: localhost:2181(CONNECTED) 33] create /names 111    //重新创建names节点(因为刚刚删除了)
Created /names
[zk: localhost:2181(CONNECTED) 34] create /names/zxc 1111   //创建/names/zxc 
Created /names/zxc
[zk: localhost:2181(CONNECTED) 35] setAcl /names world:anyone:cra   //重新设置权限
cZxid = 0x21
ctime = Sat Dec 22 16:21:44 CST 2018
mZxid = 0x21
mtime = Sat Dec 22 16:21:44 CST 2018
pZxid = 0x22
cversion = 1
dataVersion = 0
aclVersion = 1
ephemeralOwner = 0x0
dataLength = 3
numChildren = 1
[zk: localhost:2181(CONNECTED) 36] delete /names/zxc        //此时删除zxc发现delete权限生效
Authentication is not valid : /names/zxc
```

#### auth-scheme解读

设置auth权限
```shell
setAcl /auth auth:cdz:cdz:cra
Acl is not valid : /auth

//发现会报错,原因是我们还没有添加auth要使用addAuth命令来添加一个用户
[zk: localhost:2181(CONNECTED) 0] addauth digest cdz:123456 //直接添加成功没有返回
[zk: localhost:2181(CONNECTED) 1] setAcl /auth auth:cdz:123456:cra  //使用auth scheme添加权限
cZxid = 0x25
ctime = Sat Dec 22 16:27:24 CST 2018
mZxid = 0x25
mtime = Sat Dec 22 16:27:24 CST 2018
pZxid = 0x25
cversion = 0
dataVersion = 0
aclVersion = 1
ephemeralOwner = 0x0
dataLength = 2
numChildren = 0
[zk: localhost:2181(CONNECTED) 2] getAcl /auth
'digest,'cdz:hGq0vr1Ww1PViRKdAf5fa9ua7q8=   //可以看到类型为digest ,且帐户名与密码密文都有展示
: cra
[zk: localhost:2181(CONNECTED) 3]
```

此时新建窗口2
```shell
[zk: localhost:2181(CONNECTED) 0] get /auth //因为没有登录cdz这个用户,所以不能读取
Authentication is not valid : /auth
[zk: localhost:2181(CONNECTED) 1] addauth digest cdz:123456 //在登录cdz帐户之后才可以获取auth信息
[zk: localhost:2181(CONNECTED) 2] get /auth
11
cZxid = 0x25
ctime = Sat Dec 22 16:27:24 CST 2018
mZxid = 0x25
mtime = Sat Dec 22 16:27:24 CST 2018
pZxid = 0x25
cversion = 0
dataVersion = 0
aclVersion = 1
ephemeralOwner = 0x0
dataLength = 2
numChildren = 0
[zk: localhost:2181(CONNECTED) 3] setAcl /auth auth:jack:jack:crwda //重设帐户, 发现返回节点信息,感觉是成功了,其实我们想要的是报错的,原因很简单,我们根本还没有创建jack这个帐户
cZxid = 0x25
ctime = Sat Dec 22 16:27:24 CST 2018
mZxid = 0x25
mtime = Sat Dec 22 16:27:24 CST 2018
pZxid = 0x25
cversion = 0
dataVersion = 0
aclVersion = 2
ephemeralOwner = 0x0
dataLength = 2
numChildren = 0
[zk: localhost:2181(CONNECTED) 4] getAcl /auth  //但是查看信息发现根本没有生效,这是为什么?
                                                //其实设置节点属于那个访问,
                                                //这里因为已经通过addauth digest cdz:123456登录了cdz这个帐户,
                                                //这个session已经记住并且有一个登录列表,
                                                //设置auth用户时,只会取出第一个登录的auth帐户.
'digest,'cdz:hGq0vr1Ww1PViRKdAf5fa9ua7q8=
: cdrwa
[zk: localhost:2181(CONNECTED) 5] setAcl /auth auth:::ca    //故我们设置时其实直接使用默认形式
cZxid = 0x25
ctime = Sat Dec 22 16:27:24 CST 2018
mZxid = 0x25
mtime = Sat Dec 22 16:27:24 CST 2018
pZxid = 0x25
cversion = 0
dataVersion = 0
aclVersion = 3
ephemeralOwner = 0x0
dataLength = 2
numChildren = 0
[zk: localhost:2181(CONNECTED) 6] getAcl /auth
'digest,'cdz:hGq0vr1Ww1PViRKdAf5fa9ua7q8=
: ca    //看到权限是设置成功的
[zk: localhost:2181(CONNECTED) 7] addauth digest jack:jack      //我们添加一个jack用户
[zk: localhost:2181(CONNECTED) 8] setAcl /auth auth:jack:jack:cra   //设置`/auth` 用户为jack
cZxid = 0x25
ctime = Sat Dec 22 16:27:24 CST 2018
mZxid = 0x25
mtime = Sat Dec 22 16:27:24 CST 2018
pZxid = 0x25
cversion = 0
dataVersion = 0
aclVersion = 4
ephemeralOwner = 0x0
dataLength = 2
numChildren = 0
[zk: localhost:2181(CONNECTED) 9] getAcl /auth      //获取`/auth`的权限信息 ,其权限有增加了一个jack帐户,原来的cdz没有改变,意味着此时cdz,jack帐户都可以对其做操作
'digest,'cdz:hGq0vr1Ww1PViRKdAf5fa9ua7q8=
: cra
'digest,'jack:p4FVWKzcf0HsYG6jAmAOvoHGCt8=
: cra
```



