---
layout:     post
title:      Golangå­¦ä¹ ç¬”è®°åå…­
subtitle:   èµ„æºç®¡ç†ä¸é”™è¯¯å¤„ç†-åŒä¸€é”™è¯¯å¤„ç†æ¼”ç¤º
date:       2019-02-15
author:     CDz
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - Golang
---

è¿™ä¸€å°èŠ‚ä¸­,é‡åœ¨å®æˆ˜,é€šè¿‡å†™ä¸€ä¸ªæ–‡ä»¶æœåŠ¡å™¨webserverçš„ç¼–å†™,æ¥ä½“ç°GOè¯­è¨€ä¸­åŒä¸€é”™è¯¯å¤„ç†æ–¹å¼ã€‚å…¶ä¸­ä½¿ç”¨åˆ°httpåŒ…ä¸å‡½æ•°å¼ç¼–ç¨‹ã€‚
# filelistserver
å…ˆå†™å‡ºwebserveré”™è¯¯å¤„ç†ç›´æ¥panicï¼Œåé¢è¿›è¡Œæ”¹é€ 

```
func main() {
    //http.HandleFunc("/list/", errWrapper(filelisting.Handerlist))
    http.HandleFunc("/list/", func(writer http.ResponseWriter, request *http.Request) {
        path := request.URL.Path[len("/list/"):]
        file, e := os.Open(path)
        if e != nil {
            panic(e)
        }
        defer file.Close()
        readAll, e := ioutil.ReadAll(file)
        if e != nil {
            panic(e)
        }
        writer.Write(readAll)
    })
    e := http.ListenAndServe(":8888", nil)//æ‰“å¼€ä¸€ä¸ªserverç›‘å¬ 8888ç«¯å£
    if e != nil {
        panic(e)
    }
}
```

æµè§ˆå™¨è¾“å…¥`http://localhost:8888/list/fib.txt`
```
1
1
2
3
5
8
13
21
34
55
89
144
233
377
610
987
1597
2584
4181
6765
10946
```
æ‰“å°æˆåŠŸï¼Œä½†æ˜¯è¿™ä¸ªserveræ˜¯panicé”™è¯¯çš„ï¼Œå¦‚æœå‡ºé”™ä¼šç›´æ¥é¡µé¢å´©æºƒå¦‚å½“æˆ‘ä»¬è¾“å…¥`http://localhost:8888/list/fib.txta`,é¡µé¢å°±ä¼š`è¯¥ç½‘é¡µæ— æ³•æ­£å¸¸è¿ä½œ`ï¼Œè¿™æ ·å½“ç„¶å¾ˆéš¾çœ‹ã€‚

## webserveruoæ”¹é€ ç¬¬ä¸€æ­¥

ç›´æ¥å°†`func HandleFunc(pattern string, handler func(ResponseWriter, *Request))`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ŒæŠ½å–å‡ºæ¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚

```
package filelisting

import (
    "io/ioutil"
    "net/http"
    "os"
)

func Handerlist(writer http.ResponseWriter, request *http.Request)  {
    path := request.URL.Path[len("/list/"):]
    file, e := os.Open(path)
    if e != nil {
        panic(e)
    }
    defer file.Close()
    readAll, e := ioutil.ReadAll(file)
    if e != nil {
        panic(e)
    }
    writer.Write(readAll)
}
```

```
func main() {
    http.HandleFunc("/list/", filelisting.Handerlist)
    e := http.ListenAndServe(":8888", nil)
    if e != nil {
        panic(e)
    }
}
```

è¿™ä¸€æ­¥ï¼Œåªæ˜¯å°†æ–¹æ³•æŠ½å–ï¼Œå¹¶æ²¡æœ‰åšå…¶ä»–çš„äº‹æƒ…ã€‚

## webserveruoæ”¹é€ ç¬¬äºŒæ­¥

å®šä¹‰æ¥å£ï¼š`type appHandler func(writer http.ResponseWriter, request *http.Request) error`ï¼Œå…¶å®å°±æ˜¯`http.HandleFunc`ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¤šåŠ äº†ä¸€ä¸ªè¿”å›å€¼errorã€‚


å°†`filelisting.Handerlist`è¿”å›errorï¼Œå³å®ç°è¿™ä¸ªå‡½æ•°æ¥å£ã€‚
```
package filelisting

import (
    "io/ioutil"
    "net/http"
    "os"
)

func Handerlist(writer http.ResponseWriter, request *http.Request) error{ //è¿”å›error
    path := request.URL.Path[len("/list/"):]
    file, e := os.Open(path)
    if e!=nil {
        return e//ç›´æ¥å°†errorè¿”å›ï¼Œä¸Šå±‚åšå‡ºå¤„ç†
    }
    defer file.Close()
    bytes, e := ioutil.ReadAll(file)
    if e != nil {
        return e
    }
    writer.Write(bytes)
    return nil
}
```

å®šä¹‰ä¸€ä¸ªå‡½æ•°å¤„ç†å¼‚å¸¸ï¼š
```
func errWrapper( //è¿™ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯æ¥å£appHandlerï¼Œ
                //è¿”å›å‡½æ•° func(writer http.ResponseWriter, request *http.Request)
                //å³http.HandleFunc
                //å‡½æ•°ä½“ç±»å¯¹é”™è¯¯è¿›è¡Œå¤„ç†
    handler appHandler) func(
    writer http.ResponseWriter, request *http.Request) {
    return func(writer http.ResponseWriter, request *http.Request) {
        e := handler(writer, request)
        if e != nil {
            code := http.StatusOK
            switch {
            case os.IsNotExist(e):
                code = http.StatusNotFound
            case os.IsPermission(e):
                code=http.StatusForbidden//æ²¡æœ‰æƒé™
            default:
                code = http.StatusInternalServerError
            }
            http.Error(writer,http.StatusText(code),code)
        }
    }
}
```

è¿™ä¸ªå¼‚å¸¸å¤„ç†æ–¹æ³•ï¼Œå°±æ˜¯å¤„ç†ï¼Œæˆ‘ä»¬è¿”å›çš„err,å°†è¿”å›çš„errorä¿¡æ¯å¤„ç†å®Œå,è¿”å›ä¸€ä¸ª`func(writer http.ResponseWriter, request *http.Request)`å‡½æ•°.

# æ€»ç»“
æ€»ç»“é”™è¯¯å¤„ç†çš„æ•´ä½“æ€è·¯:

- å®šä¹‰æ¥å£`type appHandler func(writer http.ResponseWriter, request *http.Request) error`
- å®ç°`appHandler`æ–¹æ³•å†…å¯¹é”™è¯¯è¿”å›
- å®šä¹‰æ–¹æ³•å‚æ•°`appHandler`è¿”å›å‡½æ•°`http.HandleFunc`,æ–¹æ³•å†…å¤„ç†é”™è¯¯ä¿¡æ¯



------
ä½œè€…æ‰€æœ‰çš„å­¦ä¹ æºç åœ¨ [goå­¦ä¹ æºç githubåœ°å€](https://github.com/CDz1129/golang-learn),å¦‚æœè§‰å¾—æœ‰ç”¨çš„è¯å¸®å°æ™ºè´¡çŒ®ä¸€ä¸ªstarğŸ˜
