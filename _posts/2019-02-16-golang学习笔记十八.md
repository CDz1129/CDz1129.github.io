---
layout:     post
title:      Golangå­¦ä¹ ç¬”è®°åå…«
subtitle:   èµ„æºç®¡ç†ä¸é”™è¯¯å¤„ç†-é”™è¯¯å¤„ç†äºŒ
date:       2019-02-16
author:     CDz
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - Golang
---

å‰é¢( [Golangå­¦ä¹ ç¬”è®°åå…­](https://cdz1129.github.io/2019/02/15/golang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81%E5%85%AD/))æˆ‘ä»¬å¯¹é”™è¯¯å¤„ç†è¿›è¡Œäº†åŒä¸€çš„å¤„ç†,ä½†å…¶å®è¿˜æ˜¯æœ‰æ¼æ´,æˆ‘ä»¬å®šä¹‰çš„serveræ˜¯`/list`å¼€å¤´,å¦‚æœè¿™ä¸¤ä¸ªé€»è¾‘å¹¶ä¸æ˜¯ä¸€ä¸ªäººå†™çš„,ä¸€ä¸ªå®šä¹‰ä¸º`/`,ä¸€ä¸ªå®šä¹‰ä¸º`/list/`é‚£ä¹ˆç¨‹åºå°±ä¼šå‡ºç°é”™è¯¯.

å½“å¯åŠ¨å‡½æ•°:
```
func main() {
    //å‰ç¼€æ˜¯/æ—¶,è®¿é—®http://localhost:8888/abcé¡µé¢å°±ä¼šå¥”æºƒ.
    http.HandleFunc("/", errWrapper(filelisting.Handerlist))
    e := http.ListenAndServe(":8888", nil)
    if e != nil {
        panic(e)
    }
}
```

# æ”¹è¿›åŒä¸€é”™è¯¯å¤„ç†

åœ¨é”™è¯¯å¤„ç†å‡½æ•°`errWrapper`ä¸­æ·»åŠ recover.
```
func errWrapper(
    handler appHandler) func(
    writer http.ResponseWriter, request *http.Request) {
    return func(writer http.ResponseWriter, request *http.Request) {
        //é”™è¯¯å¤„ç†å‡½æ•°ä¹Ÿéœ€è¦recover
        defer func() {
            if r := recover(); r != nil {
                http.Error(writer,
                    http.StatusText(http.StatusInternalServerError),
                    http.StatusInternalServerError)
            }
        }()

        e := handler(writer, request)
        if e != nil {
            log.Printf("Error occurred handling request:%s",e)
            code := http.StatusOK
            switch {
            case os.IsNotExist(e):
                code = http.StatusNotFound
            case os.IsPermission(e):
                code=http.StatusForbidden//æ²¡æœ‰æƒé™
            default:
                code = http.StatusInternalServerError
            }
            http.Error(writer,http.StatusText(code),code)
        }
    }
}
```

ä½†æ˜¯è¿™ä¸ªé”™è¯¯ä¿¡æ¯,æˆ‘ä»¬å…¶å®æ˜¯å¯ä»¥é¢„è§çš„,ä¹Ÿå°±æ˜¯è¯´å¯ä»¥ç»™ç”¨æˆ·çœ‹.

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªç”¨æˆ·é”™è¯¯ç±»å‹(ä¸€ä¸ªæ¥å£):
```
type UserError interface {//å…ˆæ˜¯æœ‰errorè¿™ä¸ªæ¥å£,ç„¶åè‡ªå·±çš„æ–¹æ³•Message
    error
    Message() string
}
```

æˆ‘ä»¬åœ¨`handler.go`æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ªåŒ…è£…stringçš„ç»“æ„,å®ç°è¿™ä¸ªæ¥å£:
```
type userError string

func (u userError) Error() string {
    return u.Message()
}

func (u userError) Message() string {
    return string(u)
}
```

ç„¶ååœ¨`Handerlist`å‡½æ•°ä¸­åˆ¤æ–­:
```
const prefix string = "/list/"
func Handerlist(writer http.ResponseWriter, request *http.Request) error{
    //æ­¤å¤„åš/list/åˆ¤æ–­
    if strings.Index(request.URL.Path,prefix) != 0 { 
        //è¿”å›è‡ªå®šä¹‰çš„userError
        return userError("path must start "+prefix)
    }

    path := request.URL.Path[len(prefix):]
    file, e := os.Open(path)
    if e!=nil {
        return e
    }
    defer file.Close()
    bytes, e := ioutil.ReadAll(file)
    if e != nil {
        return e
    }
    writer.Write(bytes)
    return nil
}
```

é€šè¿‡ä¸Šé¢çš„æ”¹é€ ,æˆ‘ä»¬å°±å¯ä»¥å°†è‡ªå®šä¹‰å¯ä»¥è®©ç”¨æˆ·æŸ¥çœ‹çš„é”™è¯¯,è¿”å›åˆ°é¡µé¢ä¸Šå».

# æ€»ç»“

panicä¸error:

ä¸Šé¢æ—¶å€™ä½¿ç”¨panicä»€ä¹ˆæ—¶å€™ä½¿ç”¨error,é€šè¿‡ä¸Šé¢çš„åˆ—å­,panicæ˜¯åœ¨æˆ‘ä»¬ä¸çŸ¥é“ä»€ä¹ˆé”™è¯¯çš„æƒ…å†µä¸‹æ‰å¯ä»¥panic,æˆ‘ä»¬èƒ½ä»¥é¢„æ–™åˆ°çš„ä¸€äº›é”™è¯¯,éƒ½éœ€è¦ä½¿ç”¨error.
 
- æ„æ–™ä¹‹ä¸­çš„ä½¿ç”¨error
- æ„æ–™ä¹‹å¤–çš„ä½¿ç”¨panic

## é”™è¯¯å¤„ç†ç»¼åˆæ¡ˆä¾‹æŠ€æœ¯ç‚¹:

- defer+panic+recover
- type assertion
- å‡½æ•°å¼ç¼–ç¨‹

------
ä½œè€…æ‰€æœ‰çš„å­¦ä¹ æºç åœ¨ [goå­¦ä¹ æºç githubåœ°å€](https://github.com/CDz1129/golang-learn),å¦‚æœè§‰å¾—æœ‰ç”¨çš„è¯å¸®å°æ™ºè´¡çŒ®ä¸€ä¸ªstarğŸ˜
